# 多群组群管系统

## 基础命令

以下所有操作支持引用对方信息回复来操作：

- `/t` 踢出群组（通知/不拉黑/不计入数据库）
- `/lh` 拉黑群组（通知/计入数据库）
- `/unlh` 解除拉黑（通知/解数据库）
- `/jy` 禁言（通知/计入数据库）
- `/unjy` 解除禁言（通知/解数据库）

### 命令使用说明

以上所有操作理由/时间可填可不填，不填时间默认永久，不填理由默认不显示理由。解除时不需要填时间，可以填理由。

**时间单位：** `s`=秒，`m`=分钟，`h`=小时，`d`=天

**命令示例：**
- `/lh 10s` - 拉黑10秒，不显示理由
- `/jy 10s 违规` - 禁言10秒，理由为违规
- `/lh 违规` - 拉黑永久，理由为违规
- `/jy 违规` - 禁言永久，理由为违规

### 目标用户指定方式

支持以下两种方式指定操作目标，**两种方式同级**，可单独使用或同时使用：

1. **引用回复**：回复目标用户的消息并发送命令
2. **@用户名**：在命令中直接指定 `@username`

**命令格式识别：**
- 用户名：以 `@` 开头
- 时间：以 `s/m/h/d` 结尾
- 理由：其他文本（不限中文）
- 所有参数用空格隔开

**示例：**
- `/jy @user 1s 违规` - 禁言@user用户1秒，理由：违规
- `/jy @user 违规` - 永久禁言@user，理由：违规
- 回复消息 + `/jy 10m` - 禁言被回复用户10分钟
- 回复消息 + `/jy @user2 1h 刷屏` - 同时处理被回复用户和@user2

### 批量操作

**批量处理规则：**
- 支持同时操作多个用户：`/jy @user1 @user2 @user3 10m 违规`
- **时间和理由对所有指定用户统一生效**
- 严格遵守每秒5次操作限流（Telegram API限制）
- 批量操作会依次执行，失败的单独记录

---

## 通知模板示例

### 1. 禁言通知示例（带时间与理由）

```
🔇 [禁言通知]
[群组]：🌧 雨之居所  
[用户]：[Baoyu Zhou](tg://user?id=123456789)  
[ID]：`123456789`  
[时长]：10 秒  
[理由]：违规  
[操作时间]：2025-10-27 01:35:22
[操作人]：
```

### 2. 禁言通知示例（永久 / 无理由）

```
🔇 [禁言通知]
[群组]：🌧 雨之居所  
[用户]：[Baoyu Zhou](tg://user?id=123456789)  
[ID]：`123456789`  
[时长]：永久  
[操作时间]：2025-10-27 01:35:22
[操作人]：
```

### 3. 拉黑通知示例（带理由）

```
🚫 [拉黑通知]
[群组]：🌧 雨之居所  
[用户]：[Baoyu Zhou](tg://user?id=123456789)  
[ID]：`123456789`  
[时长]：7 天  
[理由]：发布违规内容  
[操作时间]：2025-10-27 01:35:22
[操作人]：
```

### 4. 解除拉黑通知示例（带理由）

```
🔓 [解除拉黑通知]
[群组]：🌧 雨之居所  
[用户]：[Baoyu Zhou](tg://user?id=123456789)  
[ID]：`123456789`  
[理由]：误操作  
[操作时间]：2025-10-27 01:40:10
[操作人]：
```

### 5. 解除禁言通知示例（无理由）

```
🔈 [解除禁言通知]
[群组]：🌧 雨之居所  
[用户]：[Baoyu Zhou](tg://user?id=123456789)  
[ID]：`123456789`  
[操作时间]：2025-10-27 01:42:08
[操作人]：
```

### 6. 踢出通知（不计数据库）

```
👢 [踢出通知]
[群组]：🌧 雨之居所  
[用户]：[Baoyu Zhou](tg://user?id=123456789)  
[ID]：`123456789`  
[操作时间]：2025-10-27 01:44:55
[操作人]：
```

**注意：** 以上所有通知的操作时间下面要增加个`[操作人]`字段。

## ⚙️ /config（作者专用）

**权限说明：** 仅在私信中响应作者指令，非作者用户不回复、不响应。

**交互方式：** 内联按钮 + 对话模式

### 功能说明

当作者发送 `/config` 命令后，机器人返回内联按钮菜单，包含以下功能：

#### 1. 授权群组管理
- **➕ 增加授权群组**  
  点击后进入对话模式，要求输入群组ID（格式：`-1002570701587`）  
  说明：将指定群组ID加入授权列表，只有授权群组内的管理员才可执行群管命令。

- **➖ 删除授权群组**  
  点击后显示当前授权群组列表（内联按钮），选择要删除的群组。

- **📋 查看授权群组**  
  显示所有已授权的群组列表及群组名称。

#### 2. 全局管理员管理
- **👤 增加全局管理员**  
  点击后进入对话模式，要求输入用户ID  
  说明：添加全局管理员（不受群权限影响），可在任意群组或私聊中操作机器人。即使关闭所有群管权限，全局管理员仍可使用所有命令。

- **🗑 删除全局管理员**  
  点击后显示当前全局管理员列表，选择要删除的管理员。

- **📋 查看全局管理员**  
  显示所有全局管理员列表。

#### 3. 权限控制
- **🔄 更新群组管理员权限**  
  重新同步授权群组内的管理员名单，仅授权的 Telegram 群管理员可以操作机器人。

- **🔒 关闭群组管理员权限**  
  关闭除作者外的所有群组操作权限，机器人仅响应作者本人。

- **🔓 开启群组管理员权限**  
  重新开启群组管理员操作权限。

#### 内联按钮示例界面
```
⚙️ 系统配置面板

请选择要执行的操作：

[➕ 增加授权群组] [➖ 删除授权群组]
[👤 增加全局管理员] [🗑 删除全局管理员]
[📋 授权群组列表] [📋 管理员列表]
[🔄 更新管理员权限]
[🔒 关闭群管权限] [🔓 开启群管权限]
[❌ 关闭菜单]
```

---

## 系统技术架构与运行机制

**技术栈：** Go + MySQL

**运行机制：**
- 机器人不读取也不响应启动前的命令，只读取机器人开启后的指令和信息
- 非授权群组进群后直接发送通知并退出群组
- 若强制被拉进非授权群组，也不读取该群组的信息

**数据同步：**
- 一个群拉黑（禁言/踢出），所有群拉黑（禁言/踢出）
- 统一数据库到所有授信群组

---

## 错误处理与限制

1. **操作限流**  
   分批次处理行为，每秒每个群最多5个操作行为，不论禁言、拉黑还是解除等。通知显示的是操作群组，比如在A群操作的，在其他群也会被处理，但是显示通知的是A群。

2. **权限不足处理**  
   机器人权限不足时应当通知作者。

3. **操作人显示规则**  
   通知的操作人显示的是命令发起者，而不是机器人。

---

## 时间单位与通知显示

- 禁言或拉黑带时间时，建议在通知中显示具体单位（秒、分、小时、天），避免歧义
- 例如 `/lh 10s` 显示为 `10 秒`，`/jy 2h` 显示为 `2 小时`

---

## 数据库设计

**说明：** 数据库表结构需要开发时根据实际业务需求进行设计和搭配。

**建议包含的核心表：**
- 授权群组表（authorized_groups）
- 全局管理员表（global_admins）
- 拉黑记录表（blacklist）
- 禁言记录表（mute_list）
- 操作日志表（operation_logs）
- 系统配置表（system_config）

**表设计要点：**
- 记录用户ID、用户名、群组信息、操作人信息
- 支持时间到期自动解除功能（需要定时任务）
- 记录操作理由和解除理由
- 支持跨群组数据同步
- 记录完整操作日志用于追溯

---

## 基础信息

| 项目 | 值 |
|------|-----|
| **频道ID** | `-1002474636059` |
| **作者ID** | `7556123117` |
| **数据库主机** | `gz-cynosdbmysql-grp-jj6na063.sql.tencentcdb.com` |
| **数据库端口** | `21151` |
| **数据库名** | `admin_new` |
| **用户名** | `admin_new` |
| **密码** | `04By0302` |